<!DOCTYPE html>
<html>
<head>
    <title>Barcode Scanner</title>
    <script src="https://unpkg.com/zxing-js/library@0.18.1/zxing.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        #scanner-container {
            width: 100%;
            height: auto;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Barcode Scanner</h1>
    
    <!-- File input for uploading the .csv file -->
    <input type="file" id="csvFile" accept=".csv" />
    
    <!-- Button to start scanning -->
    <button id="startScan">Start Scan</button>
    
    <!-- Display the scanned barcode result -->
    <div id="result"></div>
    
    <!-- Container for the barcode scanner video feed -->
    <div id="scanner-container"></div>

    <!-- List of accepted barcodes -->
    <h2>Accepted Barcodes</h2>
    <ul id="acceptedBarcodes"></ul>

    <script>
        // Initialize file input
        const csvFileInput = document.getElementById('csvFile');
        const acceptedBarcodesList = document.getElementById('acceptedBarcodes');
        
        // Initialize the result display div
        const resultDiv = document.getElementById('result');
        
        // Initialize the barcode scanner
        let codeReader = null;

        // Initialize the scanner when the "Start Scan" button is clicked
        document.getElementById('startScan').addEventListener('click', function() {
            const selectedDeviceId = null; // Use the default device
            const constraints = {
                video: {
                    facingMode: 'environment',
                    deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined
                }
            };
            
            codeReader = new ZXing.BrowserQRCodeReader();
            
            codeReader
                .decodeFromVideoDevice(selectedDeviceId, 'scanner-container', constraints, (result, err) => {
                    if (result) {
                        displayScannedBarcode(result.text);
                    } else if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.error(err);
                        alert('Error reading barcode: ' + err);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Error starting camera: ' + err);
                });
        });

        // Function to handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Read the uploaded .csv file
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Parse the .csv data
                    const csvData = e.target.result;
                    updateAcceptedBarcodes(csvData);
                };
                reader.readAsText(file);
            }
        }

        // Function to update the list of accepted barcodes
        function updateAcceptedBarcodes(csvData) {
            acceptedBarcodesList.innerHTML = ''; // Clear the list
            const lines = csvData.split('\n');
            for (let i = 0; i < lines.length; i++) {
                const row = lines[i].trim();
                if (row !== '') {
                    const listItem = document.createElement('li');
                    listItem.innerText = row;
                    acceptedBarcodesList.appendChild(listItem);
                }
            }
        }

        // Function to display scanned barcode and match status
        function displayScannedBarcode(scannedBarcode) {
            const acceptedBarcodes = Array.from(acceptedBarcodesList.children).map(item => item.innerText);
            
            if (acceptedBarcodes.includes(scannedBarcode)) {
                resultDiv.innerHTML = `<strong>Scanned Barcode:</strong> ${scannedBarcode}<br/><span style="color:green;"><strong>Match found in accepted barcodes.</strong></span>`;
            } else {
                resultDiv.innerHTML = `<strong>Scanned Barcode:</strong> ${scannedBarcode}<br/><span style="color:red;"><strong>No match found in accepted barcodes.</strong></span>`;
            }
        }

        // Listen for file input change event
        csvFileInput.addEventListener('change', handleFileUpload);
    </script>
</body>
</html>
